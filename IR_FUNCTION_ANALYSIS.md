# IR-Based Baseline å®ç°æ£€æŸ¥æŠ¥å‘Š

æ ¹æ® LocAgent è®ºæ–‡è¦æ±‚ï¼Œå¯¹ `ir_function` ç­–ç•¥çš„å®ç°è¿›è¡Œè¯¦ç»†æ£€æŸ¥ã€‚

## è®ºæ–‡è¦æ±‚æ€»ç»“

### 1. ç´¢å¼•ç²’åº¦ï¼ˆGranularityï¼‰ï¼šå‡½æ•°çº§ï¼ˆFunction-levelï¼‰
- âœ… æ¯ä¸ªå‡½æ•°ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ–‡æ¡£ï¼ˆDocumentï¼‰è¿›è¡Œç´¢å¼•
- âœ… ä¸Šä¸‹æ–‡å¢å¼ºï¼šæ–‡ä»¶è·¯å¾„å’Œç±»åé™„åŠ åˆ°å‡½æ•°è¡¨ç¤ºä¸­

### 2. ç´¢å¼•ç»“æ„ï¼ˆIndexing Structureï¼‰ï¼šæ‰å¹³åŒ–ç´¢å¼•ï¼ˆFlat Indexingï¼‰
- âœ… éå±‚çº§ç´¢å¼•ï¼Œæ‰€æœ‰å‡½æ•°å¹³é“ºåˆ°ä¸€ä¸ªå‘é‡åº“ä¸­

### 3. å‡½æ•°æå–ï¼ˆFunction Extractionï¼‰ï¼šé€’å½’ AST è§£æ
- âœ… ä½¿ç”¨ Python AST è§£æ
- âš ï¸ é€’å½’æå–åµŒå¥—å‡½æ•°ï¼ˆéœ€è¦éªŒè¯ï¼‰
- âœ… æœ€å°ç²’åº¦ï¼šå‡½æ•°çº§åˆ«

---

## ä»£ç å®ç°æ£€æŸ¥

### âœ… 1. å‡½æ•°çº§ç´¢å¼•ç²’åº¦

**å®ç°ä½ç½®**: `blocks_ir_function()` å‡½æ•°ï¼ˆç¬¬322-467è¡Œï¼‰

**æ£€æŸ¥ç»“æœ**: âœ… **ç¬¦åˆè¦æ±‚**

- æ¯ä¸ªå‡½æ•°éƒ½åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ `Block` å¯¹è±¡ï¼ˆç¬¬419è¡Œï¼‰
- æ¯ä¸ª Block éƒ½æœ‰å”¯ä¸€çš„ç´¢å¼•ï¼ˆç¬¬420è¡Œï¼š`block_index = len(blocks)`ï¼‰
- æ¯ä¸ªå‡½æ•°ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„åµŒå…¥å•å…ƒ

```python
# ç¬¬419-421è¡Œ
block = Block(rel, start_line, end_line, ir_representation, "ir_function")
block_index = len(blocks)
blocks.append(block)
```

---

### âš ï¸ 2. ä¸Šä¸‹æ–‡å¢å¼ºï¼ˆContext Augmentationï¼‰

**å®ç°ä½ç½®**: 
- `_extract_module_level_code()` (ç¬¬204-241è¡Œ)
- `_extract_class_attributes()` (ç¬¬244-274è¡Œ)
- `_build_ir_function_representation()` (ç¬¬277-319è¡Œ)

**æ£€æŸ¥ç»“æœ**: âš ï¸ **éƒ¨åˆ†ç¬¦åˆï¼Œä½†æœ‰æ ¼å¼é—®é¢˜**

#### âœ… ç¬¦åˆçš„éƒ¨åˆ†ï¼š

1. **æ¨¡å—çº§ä»£ç æå–**ï¼šâœ… æ­£ç¡®æå– importsã€å…¨å±€å˜é‡ï¼ˆç¬¬219-239è¡Œï¼‰
2. **ç±»å±æ€§æå–**ï¼šâœ… æ­£ç¡®æå–ç±»çº§åˆ«çš„å±æ€§ï¼ˆç¬¬259-272è¡Œï¼‰
3. **ä¸Šä¸‹æ–‡é™„åŠ **ï¼šâœ… æ¨¡å—çº§ä»£ç å’Œç±»å±æ€§éƒ½è¢«æ·»åŠ åˆ°å‡½æ•°è¡¨ç¤ºä¸­ï¼ˆç¬¬308-314è¡Œï¼‰

#### âš ï¸ æ ¼å¼é—®é¢˜ï¼š

**è®ºæ–‡è¦æ±‚æ ¼å¼**ï¼ˆç¤ºä¾‹ï¼‰ï¼š
```
[File: src/helpers/math_helpers.py]
[Class: MathUtils]
def calculate_sum(a, b):
    return a + b
```

**ä»£ç å®é™…æ ¼å¼**ï¼ˆç¬¬319è¡Œï¼‰ï¼š
```python
return " ".join(parts)  # æ‰€æœ‰å†…å®¹ç”¨ç©ºæ ¼è¿æ¥æˆä¸€è¡Œ
```

**é—®é¢˜**ï¼š
- æ‰€æœ‰å†…å®¹ï¼ˆfile_path, class_name, module_code, class_attrs, function_codeï¼‰è¢«**ç©ºæ ¼è¿æ¥**æˆä¸€è¡Œ
- è¿™ä¼šå¯¼è‡´ä»£ç æ ¼å¼ä¸¢å¤±ï¼ˆæ¢è¡Œã€ç¼©è¿›ç­‰ï¼‰
- ä½†å¯èƒ½ä¸å½±å“embeddingæ•ˆæœï¼ˆå› ä¸ºembeddingæ¨¡å‹é€šå¸¸å¤„ç†æ–‡æœ¬åºåˆ—ï¼‰

**å»ºè®®**ï¼š
- å¦‚æœè¦ä¸¥æ ¼åŒ¹é…è®ºæ–‡æ ¼å¼ï¼Œåº”è¯¥ä¿ç•™æ¢è¡Œå’Œç»“æ„
- å½“å‰å®ç°ï¼ˆç©ºæ ¼è¿æ¥ï¼‰å¯èƒ½æ˜¯ä¸ºäº†ç®€åŒ–æˆ–é€‚é…ç‰¹å®šçš„embeddingæ¨¡å‹

---

### âš ï¸ 3. é€’å½’ASTè§£æ

**å®ç°ä½ç½®**: `blocks_ir_function()` ä¸­çš„ `process_function()` å‡½æ•°ï¼ˆç¬¬378-433è¡Œï¼‰

**æ£€æŸ¥ç»“æœ**: âš ï¸ **éƒ¨åˆ†ç¬¦åˆï¼ŒåµŒå¥—å‡½æ•°å¤„ç†æœ‰å±€é™æ€§**

#### âœ… ç¬¦åˆçš„éƒ¨åˆ†ï¼š

1. **ä½¿ç”¨ASTè§£æ**ï¼šâœ… ä½¿ç”¨ `ast.parse()` (ç¬¬357è¡Œ)
2. **å¤„ç†ç±»æ–¹æ³•**ï¼šâœ… æ­£ç¡®å¤„ç†ç±»ä¸­çš„æ–¹æ³•ï¼ˆç¬¬442-444è¡Œï¼‰
3. **å¤„ç†åµŒå¥—ç±»**ï¼šâœ… å¤„ç†åµŒå¥—ç±»ä¸­çš„æ–¹æ³•ï¼ˆç¬¬446-454è¡Œï¼‰
4. **é€’å½’å¤„ç†åµŒå¥—å‡½æ•°**ï¼šâœ… ä»£ç ä¸­æœ‰é€’å½’å¤„ç†ï¼ˆç¬¬430-433è¡Œï¼‰

#### âš ï¸ åµŒå¥—å‡½æ•°å¤„ç†çš„å±€é™æ€§ï¼š

**ä»£ç å®ç°**ï¼ˆç¬¬430-433è¡Œï¼‰ï¼š
```python
# é€’å½’å¤„ç†åµŒå¥—å‡½æ•°
for child in ast.iter_child_nodes(node):
    if isinstance(child, (ast.FunctionDef, ast.AsyncFunctionDef)):
        process_function(child, class_name, class_attributes)
```

**é—®é¢˜åˆ†æ**ï¼š

1. âœ… **åµŒå¥—å‡½æ•°ä¼šè¢«æå–**ï¼šä½¿ç”¨ `ast.iter_child_nodes()` ä¼šé€’å½’è®¿é—®æ‰€æœ‰å­èŠ‚ç‚¹
2. âš ï¸ **åµŒå¥—å‡½æ•°çš„ç±»åä¼ é€’**ï¼šåµŒå¥—å‡½æ•°ä½¿ç”¨**çˆ¶å‡½æ•°çš„ç±»å**ï¼ˆ`class_name`å‚æ•°ï¼‰ï¼Œè¿™å¯èƒ½ä¸æ­£ç¡®

**ç¤ºä¾‹åœºæ™¯**ï¼š
```python
class Validator:
    def validate(self, data):
        def inner_check(x):  # åµŒå¥—å‡½æ•°
            return x > 0
        return all(inner_check(d) for d in data)
```

**å½“å‰å®ç°çš„é—®é¢˜**ï¼š
- `inner_check` çš„ `class_name` å‚æ•°ä¼šæ˜¯ `"Validator"`ï¼ˆä»çˆ¶å‡½æ•°ç»§æ‰¿ï¼‰
- ä½† `inner_check` çš„ qualified_name åº”è¯¥å¦‚ä½•è¡¨ç¤ºï¼Ÿ
- è®ºæ–‡ä¸­æåˆ°ï¼š`helpers.py::Validator.validate.<locals>.inner_check`
- ä½†ä»£ç ä¸­å¯èƒ½åªæ˜¯ï¼š`helpers.py::Validator::inner_check`ï¼ˆä¸¢å¤±äº† `validate.<locals>` éƒ¨åˆ†ï¼‰

**å»ºè®®**ï¼š
- éœ€è¦æ£€æŸ¥ nested function çš„ qualified_name æ˜¯å¦æ­£ç¡®æ„å»º
- å¯èƒ½éœ€è¦ä½¿ç”¨å‡½æ•°æ ˆæ¥è¿½è¸ªå®Œæ•´çš„å‡½æ•°è·¯å¾„

---

### âœ… 4. æ‰å¹³åŒ–ç´¢å¼•

**å®ç°ä½ç½®**: `collect_ir_function_blocks()` å‡½æ•°ï¼ˆç¬¬470-560è¡Œï¼‰

**æ£€æŸ¥ç»“æœ**: âœ… **ç¬¦åˆè¦æ±‚**

- æ‰€æœ‰å‡½æ•°éƒ½è¢«å¹³é“ºåˆ°ä¸€ä¸ª `all_blocks` åˆ—è¡¨ä¸­ï¼ˆç¬¬548è¡Œï¼š`all_blocks.extend(file_blocks)`ï¼‰
- æ²¡æœ‰å±‚çº§ç»“æ„ï¼Œæ‰€æœ‰å‡½æ•°éƒ½æ˜¯åŒä¸€å±‚çº§çš„ Block
- æœ€ç»ˆæ‰€æœ‰ Block ä¼šè¢«åµŒå…¥åˆ°ä¸€ä¸ªç»Ÿä¸€çš„å‘é‡åº“ä¸­

```python
# ç¬¬548è¡Œ
all_blocks.extend(file_blocks)
```

---

## è¯¦ç»†é—®é¢˜åˆ†æ

### é—®é¢˜1: ä¸Šä¸‹æ–‡æ ¼å¼

**ä½ç½®**: `_build_ir_function_representation()` ç¬¬319è¡Œ

**å½“å‰å®ç°**ï¼š
```python
return " ".join(parts)
```

**è®ºæ–‡è¦æ±‚**ï¼ˆæ¨æµ‹ï¼‰ï¼š
- åº”è¯¥ä¿ç•™ä»£ç çš„åŸå§‹æ ¼å¼
- æˆ–è€…ä½¿ç”¨ç‰¹å®šçš„åˆ†éš”ç¬¦/æ ‡è®°

**å½±å“**ï¼š
- æ ¼å¼ä¸¢å¤±å¯èƒ½ä¸å½±å“è¯­ä¹‰embedding
- ä½†å¯èƒ½å½±å“å¯è¯»æ€§å’Œè°ƒè¯•

**å»ºè®®**ï¼š
- å¦‚æœè®ºæ–‡æœ‰æ˜ç¡®æ ¼å¼è¦æ±‚ï¼Œéœ€è¦ä¿®æ”¹
- å¦åˆ™å½“å‰å®ç°å¯ä»¥æ¥å—ï¼ˆembeddingæ¨¡å‹é€šå¸¸å¤„ç†æ–‡æœ¬åºåˆ—ï¼‰

---

### é—®é¢˜2: åµŒå¥—å‡½æ•°çš„qualified_name

**ä½ç½®**: `process_function()` å‡½æ•°ï¼ˆç¬¬403-407è¡Œï¼Œç¬¬430-433è¡Œï¼‰

**å½“å‰å®ç°**ï¼š
```python
# æ„å»ºå®Œå…¨é™å®šåï¼ˆç”¨äº metadataï¼‰
if class_name:
    qualified_name = f"{rel}::{class_name}::{function_name}"
else:
    qualified_name = f"{rel}::{function_name}"

# é€’å½’å¤„ç†åµŒå¥—å‡½æ•°
for child in ast.iter_child_nodes(node):
    if isinstance(child, (ast.FunctionDef, ast.AsyncFunctionDef)):
        process_function(child, class_name, class_attributes)  # ä½¿ç”¨çˆ¶å‡½æ•°çš„class_name
```

**é—®é¢˜**ï¼š
- åµŒå¥—å‡½æ•°çš„ qualified_name ç¼ºå°‘çˆ¶å‡½æ•°ä¿¡æ¯
- ä¾‹å¦‚ï¼š`helpers.py::Validator::validate::inner_check` å¯èƒ½åº”è¯¥æ˜¯ `helpers.py::Validator::validate.<locals>.inner_check`

**å»ºè®®**ï¼š
- éœ€è¦å¼•å…¥å‡½æ•°æ ˆæ¥è¿½è¸ªå‡½æ•°è·¯å¾„
- æˆ–è€…æ£€æŸ¥è®ºæ–‡ä¸­æ˜¯å¦æœ‰æ˜ç¡®çš„å‘½åè§„èŒƒ

---

### é—®é¢˜3: åµŒå¥—ç±»ä¸­çš„åµŒå¥—å‡½æ•°

**ä½ç½®**: ç¬¬446-454è¡Œ

**å½“å‰å®ç°**ï¼š
```python
# å¤„ç†åµŒå¥—ç±»
elif isinstance(child, ast.ClassDef):
    nested_class_attrs = _extract_class_attributes(child, lines)
    for nested_child in child.body:
        if isinstance(nested_child, (ast.FunctionDef, ast.AsyncFunctionDef)):
            process_function(
                nested_child, 
                f"{node.name}.{child.name}",  # åµŒå¥—ç±»åï¼šOuter.Inner
                nested_class_attrs
            )
```

**æ£€æŸ¥**ï¼š
- âœ… æ­£ç¡®å¤„ç†åµŒå¥—ç±»ï¼šç±»åä½¿ç”¨ `"Outer.Inner"` æ ¼å¼
- âš ï¸ ä½†åµŒå¥—ç±»ä¸­çš„åµŒå¥—å‡½æ•°å¯èƒ½ä»æœ‰é—®é¢˜ï¼ˆå› ä¸ºåªéå†äº†ä¸€å±‚ï¼‰

---

## æ€»ç»“

### âœ… ç¬¦åˆè®ºæ–‡è¦æ±‚çš„æ–¹é¢ï¼š

1. âœ… **å‡½æ•°çº§ç´¢å¼•ç²’åº¦**ï¼šæ¯ä¸ªå‡½æ•°ä½œä¸ºç‹¬ç«‹æ–‡æ¡£
2. âœ… **ä¸Šä¸‹æ–‡å¢å¼º**ï¼šæ¨¡å—çº§ä»£ç å’Œç±»å±æ€§è¢«é™„åŠ åˆ°å‡½æ•°è¡¨ç¤º
3. âœ… **æ‰å¹³åŒ–ç´¢å¼•**ï¼šæ‰€æœ‰å‡½æ•°å¹³é“ºåˆ°ç»Ÿä¸€åˆ—è¡¨
4. âœ… **ASTè§£æ**ï¼šä½¿ç”¨Python ASTæ¨¡å—

### âš ï¸ éœ€è¦æ”¹è¿›çš„æ–¹é¢ï¼š

1. âš ï¸ **ä¸Šä¸‹æ–‡æ ¼å¼**ï¼šæ‰€æœ‰å†…å®¹ç”¨ç©ºæ ¼è¿æ¥ï¼Œä¸¢å¤±åŸå§‹æ ¼å¼ï¼ˆä½†å¯èƒ½ä¸å½±å“embeddingï¼‰
2. âš ï¸ **åµŒå¥—å‡½æ•°çš„qualified_name**ï¼šå¯èƒ½ç¼ºå°‘çˆ¶å‡½æ•°è·¯å¾„ä¿¡æ¯
3. âš ï¸ **åµŒå¥—å‡½æ•°çš„ç±»åä¼ é€’**ï¼šåµŒå¥—å‡½æ•°ä½¿ç”¨çˆ¶å‡½æ•°çš„ç±»åï¼Œå¯èƒ½ä¸å¤Ÿç²¾ç¡®

### ğŸ“ å»ºè®®ï¼š

1. **æ ¼å¼é—®é¢˜**ï¼šå¦‚æœè®ºæ–‡æ²¡æœ‰æ˜ç¡®è¦æ±‚ï¼Œå½“å‰å®ç°ï¼ˆç©ºæ ¼è¿æ¥ï¼‰å¯ä»¥æ¥å—
2. **åµŒå¥—å‡½æ•°å‘½å**ï¼šå¦‚æœéœ€è¦ç²¾ç¡®åŒ¹é…è®ºæ–‡ï¼Œå¯èƒ½éœ€è¦å¼•å…¥å‡½æ•°æ ˆæ¥æ„å»ºå®Œæ•´çš„qualified_name
3. **ä»£ç å¯è¯»æ€§**ï¼šæ·»åŠ æ›´å¤šæ³¨é‡Šè¯´æ˜åµŒå¥—å‡½æ•°çš„å¤„ç†é€»è¾‘

---

## éªŒè¯å»ºè®®

å»ºè®®ç¼–å†™æµ‹è¯•ç”¨ä¾‹éªŒè¯åµŒå¥—å‡½æ•°çš„å¤„ç†ï¼š

```python
code = """
class Validator:
    def validate(self, data):
        def inner_check(x):
            return x > 0
        return all(inner_check(d) for d in data)
"""

# æ£€æŸ¥æ˜¯å¦æå–äº† inner_check å‡½æ•°
# æ£€æŸ¥ inner_check çš„ qualified_name æ˜¯å¦æ­£ç¡®
```
